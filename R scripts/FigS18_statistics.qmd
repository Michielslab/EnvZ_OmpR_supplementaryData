---
title: "FigS18_analysis"
format: html
editor: visual
---

## Load packages

```{r}
library(readxl)
library(tidyverse)
library(rstatix)
library(DescTools)
library(openxlsx)
library(aomisc)
library(QurvE)
library(PMCMRplus)
library(reshape2)
library(effects)
library(lme4)
library(interactions)
library(extrafont)
loadfonts(device = "win")
library(ggpubr)
library(scales)
library(DHARMa)
library(emmeans)
```

## Specify path towards xlsx file

```{r}
dir.path<-choose.dir()
```

## Perform statistics on *Survival*

### Open xlsx file and transform into data frame for model fitting

```{r}
xlsx_Surv.df<-as.data.frame(
  read_excel(path=paste(dir.path,"S19_Data.xlsx",sep="//")))
#Replace numbered colnames with strain designations
new.colnames<-colnames(xlsx_Surv.df)
index=1
for (c in seq(2,length(new.colnames))){
  if(grepl(pattern="\\d$",new.colnames[c])==F){
    index=1
    last.strain=new.colnames[c]
    new.colnames[c]<-paste(last.strain,as.character(index),sep="_")
  }else{
    index=index+1
    new.colnames[c]=paste(last.strain,as.character(index),sep="_")
  }
}
colnames(xlsx_Surv.df)<-new.colnames
Surv.model.df<-melt(xlsx_Surv.df,id.vars="Time [h]",value.name = "survival",variable.name = "Strains")
Surv.model.df<-melt(xlsx_Surv.df,id.vars="Time [h]",value.name = "survival",variable.name = "Strains")
colnames(Surv.model.df)[1]<-"time"

split_strains<-
  lapply(as.character(Surv.model.df$Strains),
                      function(x) strsplit(x,split="_")[[1]])

Surv.model.df$Strains<-sapply(split_strains, function(x) x[1])
Surv.model.df$Replicates<-sapply(split_strains, function(x) x[2])
```

### Perform linear modeling

For the next section we will define and evaluate 4 linear models with increasing levels of complexity, all models rely on a log-transformed survival fraction:

\(1\) a simple linear interaction model with `Strains` and `Time` as factor.

\(2\) a linear interaction model with `Strains` and `Time` as factor including an error term based on the biological `Replicates`

\(3\) a generalized linear interaction model with `Strains` and `Time` as factor and an assumption of a Gamma distribution

\(4\) a generalized linear interaction model with `Strains` and `Time` as factor and an assumption of a Gamma distribution and including an error based on the biological `Replicates`.

```{r}
Strains.order<-unique(Surv.model.df$Strains)
Surv.model.df$Strains<-factor(Surv.model.df$Strains,
                            levels=Strains.order)

colorPalette<-c("#808080","#000000","#FFC107","#DE8BF6","#0B5490","#90BFF9")
```

```{r}
#|label: model-building
colnames(Surv.model.df)[1]<-"time"
Surv.model.df$time<-factor(Surv.model.df$time,
                         levels=sort(unique(Surv.model.df$time)))

#Definition and evaluation of the models using AIC
linear.models.list<-vector(mode="list",length=6)
names(linear.models.list)<-c("lm.gaussian","lme.gaussian","glm.gamma","glme.gamma",
                             "glm.log10","glme.log10")
linear.models.list[[1]]<-lm(log10(survival)~time*Strains,data=Surv.model.df)
linear.models.list[[2]]<-lmer(log10(survival)~time*Strains+(1|Replicates),
                                data=Surv.model.df)
linear.models.list[[3]]<-glm(survival~time*Strains,
                                family=stats::Gamma(link="log"),
                                data=Surv.model.df)
linear.models.list[[4]]<-glmer(survival~time*Strains+(1|Replicates),
                                family=stats::Gamma(link="log"),
                                data=Surv.model.df)
linear.models.list[[5]]<-glm(log(survival)~time*Strains,
                                family=stats::gaussian(),
                                data=Surv.model.df)
linear.models.list[[6]]<-glmer(log(survival)~time*Strains+(1|Replicates),
                                family=stats::gaussian(),
                                data=Surv.model.df)
aic_values<-sapply(linear.models.list,AIC)
min.AIC<-which(aic_values==min(aic_values))
preferred.model<-linear.models.list[[min.AIC]]
print(names(linear.models.list)[min.AIC])

p.Surv<-interactions::interact_plot(model = preferred.model,
              pred = time,          # Predictor for x-axis
              modx = Strains,              # Moderator for grouping (Strains)
              interval = TRUE,             # Add confidence intervals
              plot.points = TRUE,          # Add raw data points
              point.alpha = 5,           # Adjust transparency of points
              colors = colorPalette,
              vary.lty=F)          # Customize line colors
p.Surv<-p.Surv+ scale_y_continuous(trans = 'log10',
                    breaks = c(0.00001, 0.0001, 0.001, 0.01, 0.1, 1, 10, 100),
                    limits=c(0.00001,100),
                    labels=scales::label_log()) +
    labs(y = "Survival fraction",x="Time [h]")+theme_classic()+
  theme(legend.position="bottom",
        text=element_text(family = "Calibri",11*10.8/8.8),
          axis.text = element_text(family = "Calibri",11*10.8/8.8),
          axis.title=element_text(family="Calibri",12*10.8/8.8,face="bold",color="black"))
print(p.Surv)

#DHARMa model.validation
sim_res <- simulateResiduals(fittedModel = preferred.model)
plot(sim_res)
```

```{r}
#|label: post-hoc-testing
summary(preferred.model)
#simplified model (no time interaction, so regardless of time)
em.interactions<-emmeans(preferred.model,~Strains|time)
dunnett_test <- contrast(em.interactions, method = "trt.vs.ctrl", 
                          ref = "envZ* Î”ompC",
                            adjust="dunnett")
dunnett.df<-as.data.frame(summary(dunnett_test))
```

## 
